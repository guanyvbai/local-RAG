<!-- # 文件名: frontend/documents.html, 版本号: 2.1 -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>知识库管理 - 本地RAG</title>
    <style>
        :root{--bg-color:#131314;--surface-color:#1e1f20;--primary-text-color:#e3e3e3;--secondary-text-color:#bdc1c6;--border-color:#3c4043;--accent-color:#8ab4f8;--font-family:'Google Sans',Roboto,Arial,sans-serif}
        body{background-color:var(--bg-color);color:var(--primary-text-color);font-family:var(--font-family);margin:0;padding:2rem}
        .container{width:100%;max-width:960px;margin:auto}
        header{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border-color);padding-bottom:1rem;margin-bottom:2rem}
        header h1{margin:0}
        .nav-link, button{background-color:var(--surface-color);border:1px solid var(--border-color);color:var(--primary-text-color);padding:.5rem 1rem;border-radius:99px;cursor:pointer;text-decoration:none;font-size:.9rem}
        button:hover, .nav-link:hover{background-color:#2a2b2c}
        .management-section{background-color:var(--surface-color);padding:1.5rem;border-radius:8px;margin-bottom:2rem; display: flex; flex-direction: column; gap: 1.5rem;}
        .section-row{display:flex;align-items:center;gap:1rem;}
        input, select, .upload-label{background-color:#3c4043;color:var(--primary-text-color);border:1px solid var(--border-color);border-radius:4px;padding:.75rem;font-size:1rem; flex-grow: 1;}
        .upload-label{cursor:pointer; flex-grow: 0;}
        #file-input{display:none}
        #status-message{font-size:.9rem; display: inline-block;}
        .document-list{list-style:none;padding:0;margin:0}
        .document-list li, .collection-list li {display:flex;justify-content:space-between;align-items:center;background-color:var(--surface-color);padding:1rem;border-radius:8px;margin-bottom:.5rem;gap:1rem}
        .doc-info{display:flex;flex-direction:column;flex-grow:1;overflow:hidden;}
        .doc-name, .collection-name {font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .doc-collection{font-size:.8rem;color:var(--secondary-text-color);background-color:#3c4043;padding:.1rem .5rem;border-radius:99px;align-self:flex-start;margin-top:.25rem}
        .delete-btn{background:none;border:none;color:#bdc1c6;cursor:pointer;font-size:1.5rem;padding:0 .5rem;flex-shrink:0}
        .delete-btn:hover{color:#f28b82}
        h2 { border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; margin-top: 2rem; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>知识库管理</h1>
            <a href="/" class="nav-link">返回聊天</a>
        </header>

        <section class="management-section">
            <div class="section-row">
                <input type="text" id="new-collection-name" placeholder="输入新集合名称 (字母/数字/_-)">
                <button id="create-collection-btn">创建新集合</button>
            </div>
             <div class="section-row">
                <select id="collection-selector-upload" title="选择要上传到的知识库"></select>
                <label for="file-input" class="upload-label" id="upload-label">选择并上传文件</label>
                <input type="file" id="file-input" accept=".pdf,.docx,.xlsx,.txt,.json,.md">
            </div>
            <span id="status-message"></span>
        </section>

        <main>
            <h2>现有集合</h2>
            <ul class="collection-list" id="collection-list"></ul>
            <h2>知识文档列表</h2>
            <ul class="document-list" id="document-list"></ul>
        </main>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const token = localStorage.getItem('rag_access_token');
    if (!token) { window.location.href = '/login.html'; return; }
    const headers = { 'Authorization': `Bearer ${token}` };

    const fileInput = document.getElementById('file-input');
    const statusMessage = document.getElementById('status-message');
    const documentList = document.getElementById('document-list');
    const collectionSelectorUpload = document.getElementById('collection-selector-upload');
    const newCollectionNameInput = document.getElementById('new-collection-name');
    const createCollectionBtn = document.getElementById('create-collection-btn');
    const collectionList = document.getElementById('collection-list');

    const handleUnauthorized = (response) => {
        if (response.status === 401) {
            localStorage.removeItem('rag_access_token');
            window.location.href = '/login.html';
            return true;
        }
        return false;
    };
    
    // --- 集合管理 ---
    async function loadCollections() {
        try {
            const response = await fetch('/api/collections', { headers });
            if (handleUnauthorized(response)) return;
            const collections = await response.json();
            
            collectionSelectorUpload.innerHTML = '';
            collectionList.innerHTML = '';

            if (collections.length === 0) {
                 collectionList.innerHTML = '<li style="justify-content:center;color:#888;">暂无集合</li>';
            }

            collections.forEach(name => {
                // 填充上传下拉菜单
                const option = document.createElement('option');
                option.value = name;
                option.textContent = `上传到: ${name}`;
                collectionSelectorUpload.appendChild(option);

                // 渲染集合列表
                const li = document.createElement('li');
                const nameSpan = document.createElement('span');
                nameSpan.className = 'collection-name';
                nameSpan.textContent = name;
                li.appendChild(nameSpan);

                // 不能删除默认集合
                if (name !== 'general_collection') { // 注意：这里可能需要与您的默认集合名称匹配
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-btn';
                    deleteBtn.innerHTML = '&times;';
                    deleteBtn.title = `删除集合 ${name}`;
                    deleteBtn.onclick = () => deleteCollection(name);
                    li.appendChild(deleteBtn);
                }
                collectionList.appendChild(li);
            });
        } catch(e) { console.error("Failed to load collections", e); }
    }

    async function createCollection() {
        const newName = newCollectionNameInput.value.trim();
        if (!newName) {
            showStatus('集合名称不能为空', 'red');
            return;
        }
        try {
            const response = await fetch(`/api/collections/${newName}`, { method: 'POST', headers });
            if (handleUnauthorized(response)) return;
            const result = await response.json();
            if (response.ok) {
                showStatus(result.message, 'green');
                newCollectionNameInput.value = '';
                loadCollections(); // 刷新列表
            } else {
                throw new Error(result.detail || '创建失败');
            }
        } catch (error) { showStatus(`创建失败: ${error.message}`, 'red'); }
    }

    async function deleteCollection(collectionName) {
        if (!confirm(`确定要删除集合 "${collectionName}" 吗？该集合下的所有文档都将被删除，此操作无法撤销。`)) return;
        try {
            const response = await fetch(`/api/collections/${collectionName}`, { method: 'DELETE', headers });
            if (handleUnauthorized(response)) return;
            const result = await response.json();
            if (response.ok) {
                showStatus(result.message, 'orange');
                loadCollections(); // 刷新集合列表
                fetchDocuments(); // 刷新文档列表
            } else {
                throw new Error(result.detail || '删除失败');
            }
        } catch (error) { showStatus(`删除失败: ${error.message}`, 'red'); }
    }

    createCollectionBtn.addEventListener('click', createCollection);

    // --- 文档管理 ---
    async function fetchDocuments() {
        try {
            const response = await fetch('/api/documents', { headers });
            if (handleUnauthorized(response)) return;
            const docs = await response.json();
            renderDocumentList(docs);
        } catch (error) { documentList.innerHTML = '<li>加载列表失败</li>'; }
    }

    function renderDocumentList(docs) {
        documentList.innerHTML = '';
        if (docs.length === 0) { documentList.innerHTML = '<li style="justify-content:center;color:#888;">知识库为空</li>'; return; }
        docs.forEach(doc => {
            const li=document.createElement('li'); const docInfoDiv=document.createElement('div'); docInfoDiv.className='doc-info'; const nameSpan=document.createElement('div'); nameSpan.className='doc-name'; nameSpan.textContent=doc.name; nameSpan.title=doc.name; const collectionSpan=document.createElement('div'); collectionSpan.className='doc-collection'; collectionSpan.textContent=doc.collection; docInfoDiv.appendChild(nameSpan); docInfoDiv.appendChild(collectionSpan); const deleteBtn=document.createElement('button'); deleteBtn.className='delete-btn'; deleteBtn.innerHTML='&times;'; deleteBtn.title=`删除 ${doc.name}`; 
            deleteBtn.onclick=() => deleteDocument(doc.name, doc.collection);
            li.appendChild(docInfoDiv); li.appendChild(deleteBtn); documentList.appendChild(li);
        });
    }

    async function deleteDocument(filename, collectionName) {
        if (!confirm(`确定要删除文档 "${filename}" 吗？`)) return;
        try {
            const formData = new FormData();
            formData.append('collection_name', collectionName);
            const response = await fetch(`/api/documents/${filename}`, { method: 'DELETE', headers, body: formData });
            if (handleUnauthorized(response)) return;
            showStatus(`文档 ${filename} 已删除`, 'orange');
            fetchDocuments();
        } catch (error) { showStatus(`删除失败: ${filename}`, 'red'); }
    }

    fileInput.addEventListener('change', async () => {
        const file = fileInput.files[0];
        if (!file) return;
        
        const collection_name = collectionSelectorUpload.value;
        if (!collection_name) { showStatus('请先选择知识库', 'red'); return; }
        const formData = new FormData();
        formData.append('file', file);
        formData.append('collection_name', collection_name);
        
        showStatus(`正在上传 ${file.name} 到 ${collection_name}...`, 'white');
        try {
            const response = await fetch('/api/upload', { method: 'POST', headers, body: formData });
            if (handleUnauthorized(response)) return;
            const data = await response.json();
            if (response.ok) {
                showStatus(data.message || '上传成功!', 'green');
                fetchDocuments(); // 刷新文档列表
            } else {
                 throw new Error(data.detail || '上传失败');
            }
        } catch (error) {
            showStatus(`上传失败: ${error.message}`, 'red');
        } finally {
            fileInput.value = '';
        }
    });

    function showStatus(message, color){
        statusMessage.textContent = message;
        statusMessage.style.color = color;
        setTimeout(() => statusMessage.textContent = '', 4000);
    }
    
    // 初始化
    loadCollections();
    fetchDocuments();
});
</script>
</body>
</html>