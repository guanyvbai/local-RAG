<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœ¬åœ°çŸ¥è¯†é—®ç­” RAG</title>
    <link rel="stylesheet" href="local_deps/atom-one-dark.min.css">
    <script src="local_deps/highlight.min.js"></script>
    <script src="local_deps/marked.min.js"></script>
    <style>
        :root{--bg-color:#131314;--surface-color:#1e1f20;--primary-text-color:#e3e3e3;--secondary-text-color:#bdc1c6;--border-color:#3c4043;--accent-color:#8ab4f8;--font-family:'Google Sans',Roboto,Arial,sans-serif}
        body{background-color:var(--bg-color);color:var(--primary-text-color);font-family:var(--font-family);margin:0;display:flex;height:100vh;overflow:hidden}
        .sidebar{width:260px;background-color:var(--surface-color);padding:1rem;display:flex;flex-direction:column;border-right:1px solid var(--border-color);flex-shrink:0;gap:1rem}
        .sidebar-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem}
        .sidebar h2{font-size:1rem;border-bottom:1px solid var(--border-color);padding-bottom:.5rem;margin-top:0;font-weight:500}
        #new-chat-btn{background-color:var(--accent-color);color:var(--bg-color);border:none;border-radius:99px;padding:.5rem 1rem;font-size:.9rem;font-weight:700;cursor:pointer}
        .chat-history-list{list-style:none;padding:0;margin:0;overflow-y:auto;flex-grow:1;min-height:100px}
        .chat-history-list::-webkit-scrollbar{width:4px}
        .chat-history-list::-webkit-scrollbar-thumb{background:#555}
        .chat-history-list li{display:flex;align-items:center;gap:.5rem;padding:.5rem;border-radius:4px;cursor:pointer}
        .chat-history-list li:hover{background-color:#2a2b2c}
        .chat-history-list li.active{background-color:var(--accent-color);color:var(--bg-color)}
        .chat-title{flex-grow:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:.9rem}
        .chat-actions{display:none;gap:.25rem}
        .chat-history-list li:hover .chat-actions, .chat-history-list li.active .chat-actions{display:flex}
        .action-btn{background:0 0;border:none;color:var(--secondary-text-color);cursor:pointer;padding:.25rem;border-radius:4px}
        .action-btn:hover{color:var(--primary-text-color);background-color:#3c4043}
        li.active .action-btn{color:var(--bg-color)}
        li.active .action-btn:hover{background-color:rgba(255,255,255,0.2)}
        .rename-input{background-color:#444;border:1px solid var(--accent-color);color:var(--primary-text-color);border-radius:4px;padding:.25rem;font-size:.9rem;width:120px}
        .sidebar-footer{border-top:1px solid var(--border-color);padding-top:1rem;margin-top:auto;flex-shrink:0}
        .sidebar-footer a {display:block;padding:.75rem;background-color:var(--surface-color);border:1px solid var(--border-color);border-radius:4px;text-decoration:none;color:var(--primary-text-color);text-align:center;font-size:.9rem; width: 100%; box-sizing: border-box;}
        .sidebar-footer a:hover{background-color:#2a2b2c}
        .main-content{flex-grow:1;display:flex;justify-content:center}.container{width:100%;max-width:860px;display:flex;flex-direction:column;height:100%;padding:0 1rem;box-sizing:border-box}header{display:flex;justify-content:space-between;align-items:center;padding:1rem 0;flex-shrink:0}header h1{font-size:1.25rem;margin:0;font-weight:500}.header-right{display:flex;align-items:center;gap:1rem}#logout-button{background:var(--surface-color);border:1px solid var(--border-color);color:var(--primary-text-color);padding:.5rem 1rem;border-radius:99px;cursor:pointer}
        .chat-window{flex-grow:1;overflow-y:auto;padding:1rem 0;display:flex;flex-direction:column}.chat-window::-webkit-scrollbar{width:8px}.chat-window::-webkit-scrollbar-track{background:transparent}.chat-window::-webkit-scrollbar-thumb{background:#444;border-radius:4px}.chat-window::-webkit-scrollbar-thumb:hover{background:#555}.chat-log{display:flex;flex-direction:column;gap:2rem;width:100%}.welcome-view{text-align:center;margin:auto}.welcome-view .gemini-logo{font-size:4rem;font-weight:700;background:-webkit-linear-gradient(45deg,#4285F4,#9B72CB,#D96570,#F2A600);-webkit-background-clip:text;-webkit-text-fill-color:transparent}.welcome-view h2{font-size:1.5rem;font-weight:500;color:#888}.message{display:flex;gap:1rem;width:100%;line-height:1.75}.avatar{width:32px;height:32px;border-radius:50%;background-color:var(--accent-color);color:var(--bg-color);display:flex;align-items:center;justify-content:center;font-weight:700;flex-shrink:0;margin-top:2px}.assistant-message .avatar{background:-webkit-linear-gradient(45deg,#4285F4,#9B72CB)}.message-content{padding-top:4px;flex-grow:1; max-width: calc(100% - 48px);}
        .message-content p{margin:0 0 1rem}.message-content ul,.message-content ol{padding-left:1.5rem}.message-content li{margin-bottom:.5rem}.message-content pre{background-color:#0d0d0d;border:1px solid var(--border-color);border-radius:8px;padding:1rem;overflow-x:auto;position:relative}.message-content code{font-family:'Fira Code','Courier New',monospace;font-size:.9em}.code-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem;font-size:.8rem;color:var(--secondary-text-color)}.copy-btn{background:var(--surface-color);border:1px solid var(--border-color);color:var(--primary-text-color);padding:.25rem .5rem;border-radius:4px;cursor:pointer}.copy-btn:hover{background-color:#3c4043}.input-area-container{flex-shrink:0;padding:1rem 0 2rem}.input-area{display:flex;align-items:center;gap:1rem;background-color:var(--surface-color);border-radius:99px;padding:.5rem .5rem .5rem 1.5rem}#question-input{flex-grow:1;background:transparent;border:none;outline:none;color:var(--primary-text-color);font-size:1rem;line-height:1.5;resize:none;height:24px;max-height:200px}#send-button{width:40px;height:40px;border-radius:50%;border:none;background-color:var(--accent-color);color:var(--bg-color);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background-color .3s}#send-button:hover{background-color:#9ac2fa}#send-button.loading{background-color:#555;cursor:not-allowed;animation:spin 1s linear infinite}@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
        .workflow-selector-container {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 0 1rem;
            margin-bottom: 0.5rem;
            color: var(--secondary-text-color);
            font-size: 0.9rem;
        }
        #workflow-selector {
            background-color: var(--surface-color);
            color: var(--primary-text-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 0.25rem 0.5rem;
        }
        .cve-table-container { border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; margin-top: 1rem; }
        .cve-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .cve-table th, .cve-table td { padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid var(--border-color); }
        .cve-table th { background-color: #2c2d2f; font-weight: 500; }
        .cve-table tbody tr:last-child td { border-bottom: none; }
        .cve-table .cve-id-cell { color: var(--accent-color); font-weight: bold; white-space: nowrap; }
        .description-cell-content { max-height: 80px; overflow-y: auto; padding-right: 10px; }
        .description-cell-content::-webkit-scrollbar{ width: 4px; }
        .description-cell-content::-webkit-scrollbar-thumb{ background: #555; }
        .cve-severity { padding: 0.2rem 0.6rem; border-radius: 99px; font-size: 0.8rem; font-weight: 500; color: white; white-space: nowrap; }
        .cve-severity.CRITICAL { background-color: #820303; }
        .cve-severity.HIGH { background-color: #c53818; }
        .cve-severity.MEDIUM { background-color: #d19a66; }
        .cve-severity.LOW { background-color: #56b6c2; }
.structured-table-wrapper {
  border: 1px solid var(--border-color);
  border-radius: 8px;
  margin-top: 0.5rem;
  overflow: auto;
  background:#111;
}
.structured-table {
  width: 100%;
  border-collapse: collapse;
  table-layout: auto;       /* æŒ‰å†…å®¹è‡ªåŠ¨åˆ†é…åˆ—å®½ */
  font-size: 0.9rem;
  min-width: 720px;
}
.structured-table thead th {
  position: sticky; top: 0;
  background: #2c2d2f;
  color: #fff;
  font-weight: 600;
  text-align: left;
  padding: 10px 12px;
  border-bottom: 1px solid var(--border-color);
  z-index: 1;
}
.structured-table tbody td {
  padding: 10px 12px;
  border-bottom: 1px solid var(--border-color);
  vertical-align: top;
  word-break: normal;       /* å…³é”®åˆ—ä¸æ‹†åˆ†å­—ç¬¦ */
  overflow-wrap: anywhere;
}
.structured-table tbody tr:nth-child(odd){ background: rgba(255,255,255,0.02); }
.structured-table tbody tr:hover{ background: rgba(99,102,241,0.08); }

.cell-nowrap{ white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.cell-mono{ font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono","Courier New",monospace; }
.w-id{ max-width:260px; } .w-ip{ max-width:160px; } .w-cpe{ max-width:460px; }

.badge{ display:inline-block; padding:.15rem .45rem; border-radius:.5rem;
  background:#eef2ff; color:#3730a3; font-size:12px; line-height:1.2; }

.muted{ color:var(--secondary-text-color); }
    </style>
</head>
<body>
    <aside class="sidebar">
        <div class="sidebar-header">
            <h2>è¿‘æœŸå¯¹è¯</h2>
            <button id="new-chat-btn">+ æ–°å¯¹è¯</button>
        </div>
        <ul class="chat-history-list" id="chat-history-list"></ul>
        <div class="sidebar-footer">
            <a href="/documents.html">ç®¡ç†çŸ¥è¯†åº“</a>
        </div>
    </aside>

    <div class="main-content">
      <div class="container">
          <header>
              <h1 id="chat-title">æœ¬åœ°RAG</h1>
              <div class="header-right">
                <button id="logout-button">ç™»å‡º</button>
              </div>
          </header>
          <main class="chat-window">
              <div class="chat-log" id="chat-log">
                  <div class="welcome-view" id="welcome-view">
                      <div class="gemini-logo">G</div>
                      <h2>å¼€å§‹ä¸€æ®µæ–°çš„å¯¹è¯</h2>
                  </div>
              </div>
          </main>
          <footer class="input-area-container">
              <div class="workflow-selector-container">
                  <label for="workflow-selector">é€‰æ‹©ä¸šåŠ¡åœºæ™¯:</label>
                  <select id="workflow-selector"></select>
              </div>
              <div class="input-area">
                  <textarea id="question-input" placeholder="è¯·è¾“å…¥ä½ çš„é—®é¢˜..." rows="1"></textarea>
                  <button id="send-button" title="å‘é€">
                      <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="#131314"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2 .01 7z"/></svg>
                  </button>
              </div>
          </footer>
      </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', async () => {
    const token = localStorage.getItem('rag_access_token');
    if (!token) { window.location.href = '/login.html'; return; }
    const headers = { 'Authorization': `Bearer ${token}` };

    const chatLog = document.getElementById('chat-log');
    const questionInput = document.getElementById('question-input');
    const sendButton = document.getElementById('send-button');
    const welcomeView = document.getElementById('welcome-view');
    const newChatBtn = document.getElementById('new-chat-btn');
    const chatHistoryList = document.getElementById('chat-history-list');
    const logoutButton = document.getElementById('logout-button');
    const workflowSelector = document.getElementById('workflow-selector');
    
    let currentChatId = null;

    async function loadWorkflows() {
        try {
            const response = await fetch('/api/workflows', { headers });
            if (!response.ok) { throw new Error('Failed to load workflows'); }
            const workflows = await response.json();
            workflowSelector.innerHTML = '';
            workflows.forEach(workflow => {
                const option = document.createElement('option');
                option.value = workflow.value;
                option.textContent = workflow.name;
                workflowSelector.appendChild(option);
            });
        } catch (e) { console.error(e); }
    }
    
    async function loadUserChats() {
        try {
            const response = await fetch('/api/chats', { headers });
            if(!response.ok) { if(response.status === 401) { window.location.href = '/login.html'; } throw new Error('Failed'); }
            const chats = await response.json();
            renderChatList(chats);
            if (chats.length > 0 && !currentChatId) { switchChat(chats[0].id); } 
            else if (chats.length === 0) { startNewChat(); }
        } catch(e) { console.error(e); }
    }

    function renderChatList(chats) {
        chatHistoryList.innerHTML = '';
        chats.forEach(chat => {
            const li = document.createElement('li');
            li.dataset.chatId = chat.id;
            li.innerHTML = `<span class="chat-title">${chat.title}</span><div class="chat-actions"><button class="action-btn rename-btn" title="é‡å‘½å">âœï¸</button><button class="action-btn delete-btn" title="åˆ é™¤">ğŸ—‘ï¸</button></div>`;
            if (chat.id === currentChatId) li.classList.add('active');
            chatHistoryList.appendChild(li);
        });
    }

    chatHistoryList.addEventListener('click', (e) => {
        const target = e.target;
        const li = target.closest('li');
        if (!li) return;
        const chatId = parseInt(li.dataset.chatId);
        if (target.classList.contains('rename-btn')) {
            e.stopPropagation();
            toggleRename(li, chatId, li.querySelector('.chat-title').textContent);
        } else if (target.classList.contains('delete-btn')) {
            e.stopPropagation();
            deleteChat(chatId);
        } else {
            switchChat(chatId);
        }
    });

    function toggleRename(li, chatId, currentTitle) {
        const titleSpan = li.querySelector('.chat-title');
        if (li.querySelector('.rename-input')) return;
        titleSpan.style.display = 'none';
        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'rename-input';
        input.value = currentTitle;
        const saveRename = async () => {
            const newTitle = input.value.trim();
            if (newTitle && newTitle !== currentTitle) {
                await fetch(`/api/chats/${chatId}/rename`, {
                    method: 'PUT',
                    headers: { ...headers, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ new_title: newTitle })
                });
                titleSpan.textContent = newTitle;
            }
            if(li.contains(input)) li.removeChild(input);
            titleSpan.style.display = 'block';
        };
        input.onblur = saveRename;
        input.onkeydown = (e) => {
            if (e.key === 'Enter') saveRename();
            if (e.key === 'Escape') { 
                if(li.contains(input)) li.removeChild(input);
                titleSpan.style.display = 'block';
            }
        };
        li.insertBefore(input, li.querySelector('.chat-actions'));
        input.focus();
        input.select();
    }

    async function deleteChat(chatId) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ®µå¯¹è¯å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚')) return;
        await fetch(`/api/chats/${chatId}`, { method: 'DELETE', headers });
        if (currentChatId === chatId) currentChatId = null;
        loadUserChats();
    }

    async function switchChat(chatId) {
        if(currentChatId === chatId && chatLog.children.length > 1) return;
        currentChatId = chatId;
        const response = await fetch(`/api/chats/${chatId}`,{headers});
        if(!response.ok){ if(response.status===401) window.location.href='/login.html'; return; }
        const messages = await response.json();
        chatLog.innerHTML='';
        if (messages.length === 0) {
            welcomeView.style.display = 'block';
            if(!chatLog.contains(welcomeView)) chatLog.appendChild(welcomeView);
        } else {
            welcomeView.style.display = 'none';
            messages.forEach(msg => {
                if (msg.role === 'assistant' && msg.content.startsWith('__VULN_PAYLOAD__')) {
                    try {
                        const payload = JSON.parse(msg.content.replace('__VULN_PAYLOAD__', ''));
                        displayVulnerabilities(payload.cpe, payload.vulnerabilities, addMessage('assistant', ''));
                    } catch (e) { addMessage('assistant', 'æ— æ³•è§£æå†å²æ¼æ´æ•°æ®ã€‚'); }
                } else if (msg.role === 'assistant' && msg.content.startsWith('__TABLE_PAYLOAD__')) {
                    try {
                        const payload = JSON.parse(msg.content.replace('__TABLE_PAYLOAD__', ''));
                        displayStructuredData(payload.rows, addMessage('assistant', ''), payload.query);
                    } catch (e) { addMessage('assistant', 'æ— æ³•è§£æèµ„äº§æ•°æ®ã€‚'); }
                } else { addMessage(msg.role, msg.content); }
            });
        }
        document.querySelectorAll('.chat-history-list li').forEach(li => {
            li.classList.toggle('active', parseInt(li.dataset.chatId) === chatId);
        });
    }

    async function startNewChat() {
        try {
            const response = await fetch('/api/chats', { method: 'POST', headers });
            if (!response.ok) { if (response.status === 401) window.location.href = '/login.html'; throw new Error('Failed to create chat');}
            const newChat = await response.json();
            await loadUserChats();
            await switchChat(newChat.id);
        } catch (e) { console.error(e); }
    }
    
    newChatBtn.addEventListener('click', startNewChat);
    logoutButton.addEventListener('click',()=>{localStorage.removeItem('rag_access_token');window.location.href='/login.html'});
    questionInput.addEventListener('input',()=>{questionInput.style.height='auto';questionInput.style.height=questionInput.scrollHeight+'px'});

    async function handleSend() {
        const question = questionInput.value.trim();
        if (!question || !currentChatId) return;
        await saveMessage('user', question);
        addMessage('user', question);
        questionInput.value = '';
        questionInput.style.height = 'auto';
        setLoading(true);
        await handleN8nWorkflow(question, workflowSelector.value);
        setLoading(false);
    }

    async function handleN8nWorkflow(question, workflow) {
        const assistantMessageElem = addMessage('assistant', 'â–');
        try {
            const response = await fetch('http://localhost:5678/webhook/ask', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ question, chat_id: currentChatId, workflow, token: token })
            });
            if (!response.ok) { throw new Error(`HTTP error! Status: ${response.status}`); }

            // âœ… æ™ºèƒ½æ£€æµ‹æ¼æ´JSONæ•°æ®
            // è¯»å– webhook å“åº”
const responseText = await response.text();

// ============ è°ƒè¯•ä¸å·¥å…·å‡½æ•° ============
const DEBUG = new URLSearchParams(location.search).get('debug') === '1';
const workflowSelector =
  document.getElementById('workflow') ||
  document.querySelector('[data-workflow-select]') ||
  null;

function tryParseJSON(txt){ try { return JSON.parse(txt); } catch { return null; } }
function extractJSONArrayFromText(txt){
  const m = txt && txt.match(/\[[\s\S]*\]/); // æŠ ç¬¬ä¸€ä¸ª [ ... ]
  return m ? tryParseJSON(m[0]) : null;
}
function coerceRows(any){
  if (Array.isArray(any) && any.length && typeof any[0] === 'object' && !Array.isArray(any[0])) return any;
  if (typeof any === 'string') return coerceRows(tryParseJSON(any)) || extractJSONArrayFromText(any);
  if (any && typeof any === 'object'){
    if (Array.isArray(any.data))  return coerceRows(any.data);
    if (Array.isArray(any.items)) return coerceRows(any.items);
  }
  return null;
}
function debugPanel(info){
  if(!DEBUG) return;
  const box = document.createElement('pre');
  box.style.cssText = 'position:fixed;right:8px;bottom:8px;max-width:48vw;max-height:40vh;overflow:auto;background:#0b1021;color:#d1e2ff;border:1px solid #3a4a7a;border-radius:8px;padding:8px;font-size:12px;z-index:9999';
  box.textContent = '[N8N DEBUG]\n' + JSON.stringify(info, null, 2);
  document.body.appendChild(box);
}

// ============ è§£æä¸åˆ¤å®š ============
let parsed = tryParseJSON(responseText);
let rows = null; // <<< å…ˆå£°æ˜ï¼Œåé¢ç»Ÿä¸€èµ‹å€¼

const isArray = Array.isArray(parsed);
const isObjectArray = isArray && parsed.every(x => x && typeof x === 'object' && !Array.isArray(x));
const hasCveId = isArray && parsed.some(x => x && typeof x === 'object' && 'cve_id' in x);
const selectedWorkflowLabel = workflowSelector?.selectedOptions?.[0]?.textContent?.trim() || '';
const isCveWorkflow = (workflow === 'cve_query') || selectedWorkflowLabel.includes('CVEå…³è”åˆ†æ');

// è°ƒè¯•é¢æ¿
debugPanel({
  workflow,
  selectedWorkflowLabel,
  responseTextSample: responseText.slice(0, 400),
  parseOk: parsed !== null,
  isArray, isObjectArray, hasCveId, length: isArray ? parsed.length : undefined,
  firstKeys: isObjectArray ? Object.keys(parsed[0] || {}).slice(0, 10) : undefined,
});

// â‘  æ¼æ´æ•°ç»„ä¼˜å…ˆ
if (isObjectArray && hasCveId) {
  displayVulnerabilities(question, parsed, assistantMessageElem);
  await saveMessage('assistant', `__VULN_PAYLOAD__${JSON.stringify({ cpe: question, vulnerabilities: parsed })}`);
  return;
}

// â‘¡ èµ„äº§/é€šç”¨å¯¹è±¡æ•°ç»„ï¼ˆå®½æ¾è§£æï¼‰
rows = isObjectArray ? parsed : (coerceRows(parsed) || extractJSONArrayFromText(responseText));

// â˜… å…¼å®¹â€œå•å¯¹è±¡â€ï¼šå¦‚æœ parsed æ˜¯ {â€¦}ï¼ŒåŒ…æˆæ•°ç»„
if (!rows && parsed && typeof parsed === 'object' && !Array.isArray(parsed)) {
  rows = [parsed];
}

// å‘½ä¸­å¯¹è±¡æ•°ç»„ â†’ è¡¨æ ¼æ¸²æŸ“
if (Array.isArray(rows) && rows.length && typeof rows[0] === 'object' && !Array.isArray(rows[0])) {
  displayStructuredData(rows, assistantMessageElem, question);
  await saveMessage('assistant', `__TABLE_PAYLOAD__${JSON.stringify({ query: question, rows })}`);
  return;
}


            // âœ… å¦åˆ™èµ°æµå¼æ¸²æŸ“
            const reader = new ReadableStream({
                start(controller) {
                    controller.enqueue(new TextEncoder().encode(responseText));
                    controller.close();
                }
            }).getReader();
            const decoder = new TextDecoder();
            let fullResponse = "";
            assistantMessageElem.innerHTML = "";
            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                fullResponse += decoder.decode(value, { stream: true });
                assistantMessageElem.innerHTML = marked.parse(fullResponse + "â–");
            }
            assistantMessageElem.innerHTML = marked.parse(fullResponse);
            assistantMessageElem.querySelectorAll("pre code").forEach(addCodeBlockFeatures);
            await saveMessage('assistant', fullResponse);

        } catch (error) {
            assistantMessageElem.innerHTML = `<p style="color:red;">æŠ±æ­‰ï¼Œå›ç­”æ—¶å‡ºç°é”™è¯¯: ${error.message}</p>`;
        }
    }

    async function saveMessage(role, content) {
        await fetch(`/api/chats/${currentChatId}/messages`, {
            method: 'POST',
            headers: { ...headers, 'Content-Type': 'application/json' },
            body: JSON.stringify({ role, content })
        });
    }

    function addMessage(sender, text) {
        if(sender === 'user' && chatLog.contains(welcomeView)) welcomeView.style.display = "none";
        const messageElem = document.createElement("div");
        messageElem.classList.add("message", `${sender}-message`);
        const avatar = document.createElement("div");
        avatar.classList.add("avatar");
        const messageContent = document.createElement("div");
        messageContent.classList.add("message-content");
        if (sender === "user") {
            avatar.textContent = "U";
            messageContent.textContent = text;
        } else {
            avatar.textContent = "G";
            if (text) {
                 messageContent.innerHTML = marked.parse(text);
                 messageContent.querySelectorAll("pre code").forEach(addCodeBlockFeatures);
            }
        }
        messageElem.appendChild(avatar);
        messageElem.appendChild(messageContent);
        chatLog.appendChild(messageElem);
        chatLog.parentElement.scrollTop = chatLog.parentElement.scrollHeight;
        return messageContent;
    }

    function displayVulnerabilities(cpe, vulnerabilities, element) {
        if (!vulnerabilities || !Array.isArray(vulnerabilities) || vulnerabilities.length === 0) {
            element.innerHTML = `<p>æœªæ‰¾åˆ°ä¸ CPE "${cpe}" ç›¸å…³çš„æ¼æ´ä¿¡æ¯ï¼Œæˆ–è¿”å›çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®ã€‚</p>`;
            return;
        }
        let html = `<p>ä¸º <strong>${cpe}</strong> æ‰¾åˆ°äº† ${vulnerabilities.length} æ¡ç›¸å…³æ¼æ´ï¼š</p>`;
        html += '<div class="cve-table-container">';
        html += '<table class="cve-table">';
        html += `<thead><tr><th>CVE ID</th><th>Severity</th><th>CVSS Score</th><th>Description</th></tr></thead>`;
        html += '<tbody>';
        vulnerabilities.forEach(vuln => {
            const severity = (vuln.severity || 'UNKNOWN').toUpperCase();
            html += `
                <tr>
                    <td class="cve-id-cell">${vuln.cve_id || 'N/A'}</td>
                    <td><span class="cve-severity ${severity}">${severity}</span></td>
                    <td>${vuln.base_score || 'N/A'}</td>
                    <td><div class="description-cell-content">${vuln.description || 'No description available.'}</div></td>
                </tr>`;
        });
        html += '</tbody></table></div>';
        element.innerHTML = html;
        chatLog.parentElement.scrollTop = chatLog.parentElement.scrollHeight;
    }


    function escapeHtml(value) {
        if (value === null || value === undefined) return '';
        return String(value)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    function formatCellValue(value) {
        if (value === null || value === undefined || value === '') return 'â€”';
        if (typeof value === 'object') {
            try {
                return escapeHtml(JSON.stringify(value));
            } catch (e) {
                return 'â€”';
            }
        }
        return escapeHtml(value);
    }

 

    function escapeHtml(value) {
        if (value === null || value === undefined) return '';
        return String(value)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    function formatCellValue(value) {
        if (value === null || value === undefined || value === '') return 'â€”';
        if (typeof value === 'object') {
            try {
                return escapeHtml(JSON.stringify(value));
            } catch (e) {
                return 'â€”';
            }
        }
        return escapeHtml(value);
    }

    function displayStructuredData(rows, element, query = '') {
  if (!Array.isArray(rows) || rows.length === 0) {
    element.innerHTML = `<p class="muted">æœªæ£€æµ‹åˆ°å¯å±•ç¤ºçš„æ•°æ®ã€‚</p>`;
    return;
  }

  // æŒ‰éœ€å±•ç¤ºçš„ä¼˜å…ˆåˆ—åï¼›ç¼ºå¤±åˆ™è·³è¿‡ï¼›å…¶ä½™å­—æ®µæŒ‰åŸé¡ºåºå±•ç¤º
  const preferred = [
    'report_assets_id','cpe_key','cpe',
    'asset_id','asset_name','manage_ip',
    'is_access','system_name','location',
    'information_model','information_version',
    'brand_name','update_time'
  ];
  const row0 = rows[0];
  const keysPreferred = preferred.filter(k => k in row0);
  const keysExtra = Object.keys(row0).filter(k => !keysPreferred.includes(k));
  const cols = [...keysPreferred, ...keysExtra];

  // å®šä¹‰æ¯åˆ—çš„æ ·å¼ class
  const colClass = {
    report_assets_id: 'cell-nowrap cell-mono w-id',
    asset_id:         'cell-nowrap cell-mono w-id',
    manage_ip:        'cell-nowrap cell-mono w-ip',
    cpe:              'cell-nowrap cell-mono w-cpe',
    cpe_key:          'cell-nowrap cell-mono w-cpe',
  };

  // æ ‡é¢˜æ–‡å­—
  const headerText = query
    ? `é’ˆå¯¹ <strong>${escapeHtml(query)}</strong> è¿”å›äº† <b>${rows.length}</b> æ¡ç»“æ„åŒ–æ•°æ®ï¼š`
    : `å…± <b>${rows.length}</b> æ¡ç»“æ„åŒ–æ•°æ®ï¼š`;

  let html = `<p>${headerText}</p>`;
  html += `<div class="structured-table-wrapper"><table class="structured-table">`;
  // è¡¨å¤´
  html += `<thead><tr>${cols.map(c => `<th>${escapeHtml(c)}</th>`).join('')}</tr></thead><tbody>`;
  // æ¯è¡Œæ•°æ®
  html += rows.map(row => {
    return `<tr>${cols.map(c => {
      const val = row?.[c];
      const cls = colClass[c] || '';
      return `<td class="${cls}">${formatCellValue(c, val)}</td>`;
    }).join('')}</tr>`;
  }).join('');
  html += `</tbody></table></div>`;

  element.innerHTML = html;
}
    function escapeHtml(value) {
        if (value === null || value === undefined) return '';
        return String(value)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    function formatCellValue(value) {
        if (value === null || value === undefined || value === '') return 'â€”';
        if (typeof value === 'object') {
            try {
                return escapeHtml(JSON.stringify(value));
            } catch (e) {
                return 'â€”';
            }
        }
        return escapeHtml(value);
    }

    function addCodeBlockFeatures(block) {
        const pre = block.parentElement;
        if(pre.querySelector('.code-header')) return;
        const header = document.createElement('div');
        header.className = 'code-header';
        const lang = [...block.classList].find(c => c.startsWith('language-'))?.replace('language-', '') || 'text';
        header.innerHTML = `<span>${lang}</span><button class="copy-btn">å¤åˆ¶</button>`;
        pre.insertBefore(header, block);
        header.querySelector('.copy-btn').addEventListener('click', () => {
            navigator.clipboard.writeText(block.textContent).then(() => {
                header.querySelector('.copy-btn').textContent = 'å·²å¤åˆ¶!';
                setTimeout(() => { header.querySelector('.copy-btn').textContent = 'å¤åˆ¶'; }, 2000);
            });
        });
        if (window.hljs) {
            hljs.highlightElement(block);
        }
    }

    function setLoading(isLoading) {
        const btn = sendButton;
        if(isLoading){
            btn.classList.add('loading');
            btn.disabled = true;
            btn.innerHTML = '<div></div>';
        } else {
            btn.classList.remove('loading');
            btn.disabled = false;
            btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="#131314"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2 .01 7z"/></svg>`;
        }
    }
    
    sendButton.addEventListener('click', handleSend);
    questionInput.addEventListener('keypress', e => {
        if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); handleSend(); }
    });

    loadWorkflows();
    loadUserChats();
});
</script>
</body>
</html>
